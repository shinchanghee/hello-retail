frameworkVersion: "^4.1.12"

service: hello-retail-product-photos-data

custom:
  stage: dev


provider:
  name: aws
  runtime: nodejs20.x
  region: ap-northeast-2
  stage: dev
resources:
  Resources:
    # A DynamoDB table for recording the assignments that a photographer has 1) registered for and 2) completed.  The
    # hash key will be the unique ID of a photographer and the record will additionally contain the total registrations
    # for the photographer with the given ID as well as completed assignments, the last eventId used to register, and
    # a TTL for the record.
    PhotoRegistrations:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: assignments
            AttributeType: N
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        TableName: dev-hello-retail-product-photos-data-PhotoRegistrations-1
        GlobalSecondaryIndexes:
          - IndexName: Assignments
            KeySchema:
              - AttributeName: assignments
                KeyType: HASH
            Projection:
              ProjectionType: ALL
    # A DynamoDB table for recording the relationships between photographers and the StepFunctions executions that
    # have requested that they take a photograph.  Although only the phone number is the hash key, the table will be
    # filled with the 'taskToken', 'taskEvent', and assignment 'status' associated with a StepFunction's execution's
    # current photographer assignment.  This facilitates the timing out of a photographer that took too long to fulfill
    # their assignment.
    PhotoAssignments:
      Type: 'AWS::DynamoDB::Table'
      Properties:
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        TableName: dev-hello-retail-product-photos-data-PhotoAssignments-1
  Outputs:
    # Registrations
    PhotoRegistrationsTableName:
      Description: The Name of the Photo Registrations Table
      Value:
        Ref: PhotoRegistrations
      Export:
        Name: hello-retail-product-photos-data:dev:PhotoRegistrationsTableName:1
    PhotoRegistrationsTableArn:
      Description: The ARN for the Photo Registrations Table
      Value:
        'Fn::Join':
          - '/'
          - - !Sub 'arn:aws:dynamodb:ap-northeast-2:590183717745:table'
            - Ref: PhotoRegistrations
      Export:
        Name: hello-retail-product-photos-data:dev:PhotoRegistrationsTableArn:1
    PhotoRegistrationsTableAssignmentsIndexArn:
      Description: The ARN for the Photo Registrations Table's Assignments Index
      Value:
        'Fn::Join':
          - '/'
          - - !Sub 'arn:aws:dynamodb:ap-northeast-2:590183717745:table'
            - Ref: PhotoRegistrations
            - index
            - Assignments
      Export:
        Name: hello-retail-product-photos-data:dev:PhotoRegistrationsTableAssignmentsIndexArn:1
    # Active Assignments
    PhotoAssignmentsTableName:
      Description: The Name of the Photo Assignments Table
      Value:
        Ref: PhotoAssignments
      Export:
        Name: hello-retail-product-photos-data:dev:PhotoAssignmentsTableName:1
    PhotoAssignmentsTableArn:
      Description: The ARN for the Photo Assignments Table
      Value:
        'Fn::Join':
          - '/'
          - - !Sub 'arn:aws:dynamodb:ap-northeast-2:590183717745:table'
            - Ref: PhotoAssignments
      Export:
        Name: hello-retail-product-photos-data:dev:PhotoAssignmentsTableArn:1
